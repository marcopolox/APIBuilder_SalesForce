<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/schema/generateSchema.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">lib/schema/</a> generateSchema.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">50.88% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>29/57</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">39.29% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>11/28</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">55.56% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50.88% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>29/57</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var fs = require('fs'),
	path = require('path'),
	moment = require('moment');
&nbsp;
exports.generateSchema = function generateSchema(next) {
	var self = this;
	<span class="missing-if-branch" title="if path not taken" >I</span>if (self.config.schemaRefresh === false) {
<span class="cstat-no" title="statement not covered" >		self.logger.debug('skipping generation of schema, config.schemaRefresh is false');</span>
<span class="cstat-no" title="statement not covered" >		return next &amp;&amp; next();</span>
	}
&nbsp;
	/*
	 Use a hashed filename based on the configured authentication so if
	 they change their config, we will update the schema too.
	 */
	var confDir = self.getCacheDir(),
		hashedFilename = 'salesforce-schema-' + self.md5((self.config.generateModels || <span class="branch-1 cbranch-no" title="branch not covered" >[])</span>.join('.') + self.config.username + self.config.token) + '.json';
&nbsp;
	// If schemaCache is false, we look it up every time.
	<span class="missing-if-branch" title="if path not taken" >I</span>if (self.config.schemaCache === false) {
<span class="cstat-no" title="statement not covered" >		self.cleanGeneratedModels();</span>
<span class="cstat-no" title="statement not covered" >		return self.describeGlobal(confDir, hashedFilename, next);</span>
	}
&nbsp;
	var cachedFileName = path.join(confDir, hashedFilename),
		schemaRefresh = self.config.schemaRefresh === undefined ? <span class="branch-0 cbranch-no" title="branch not covered" >3.6e+6 </span>: self.config.schemaRefresh;
&nbsp;
	fs.exists(cachedFileName, function schemaExists(exists) {
		if (!exists) {
			self.logger.debug('schema file not found, will generate');
			self._cachedSchema = null;
			self.cleanGeneratedModels();
			self.describeGlobal(confDir, hashedFilename, next);
		}
		else {
			checkCachedVersion();
		}
	});
&nbsp;
	/**
	 * Checks if the cached schema can be used without talking to the server at all.
	 */
	function checkCachedVersion() {
		self.logger.debug('cached schema file found', cachedFileName);
		var stats = fs.statSync(cachedFileName),
			refresh = +stats.mtime + schemaRefresh;
&nbsp;
		self.logger.debug('cached schema file',
			'last update =', moment(stats.mtime).fromNow(),
			'&amp;&amp; time to refresh =', moment(refresh).fromNow());
&nbsp;
		// if we modified the file &lt; refresh time, we can reuse it
		<span class="missing-if-branch" title="else path not taken" >E</span>if (Date.now() &lt; refresh) {
			useCachedVersion();
		}
		else {
<span class="cstat-no" title="statement not covered" >			lookForUpdates(stats);</span>
		}
	}
&nbsp;
	/**
	 * Checks if the server has newer information than what we have in our cached schema.
	 */
<span class="fstat-no" title="function not covered" >	function lookForUpdates(stats) {</span>
<span class="cstat-no" title="statement not covered" >		self.logger.debug('checking for updates to the cached schema file');</span>
<span class="cstat-no" title="statement not covered" >		self.baseConnection.request({</span>
				method: 'GET',
				url: '/sobjects',
				headers: {
					'If-Modified-Since': moment(stats.mtime).format('ddd, DD MMM YYYY HH:mm:ss z')
				}
			},
<span class="fstat-no" title="function not covered" >			function (err, res) {</span>
<span class="cstat-no" title="statement not covered" >				if (err) {</span>
<span class="cstat-no" title="statement not covered" >					self.logger.error('checking for updates failed');</span>
<span class="cstat-no" title="statement not covered" >					self.logger.error(err);</span>
<span class="cstat-no" title="statement not covered" >					return;</span>
				}
&nbsp;
<span class="cstat-no" title="statement not covered" >				if (res === '') {</span>
<span class="cstat-no" title="statement not covered" >					self.logger.debug('the schema is up to date');</span>
<span class="cstat-no" title="statement not covered" >					var timestamp = new Date();</span>
<span class="cstat-no" title="statement not covered" >					fs.utimesSync(cachedFileName, timestamp, timestamp);</span>
<span class="cstat-no" title="statement not covered" >					useCachedVersion();</span>
				}
				else {
<span class="cstat-no" title="statement not covered" >					self.logger.debug('schema file updates are available, regenerating');</span>
					// TODO: Don't throw out the whole schema file, just update the changed objects...
<span class="cstat-no" title="statement not covered" >					self._cachedSchema = null;</span>
<span class="cstat-no" title="statement not covered" >					self.cleanGeneratedModels();</span>
<span class="cstat-no" title="statement not covered" >					self.describeGlobal(confDir, hashedFilename, next);</span>
				}
			});
	}
&nbsp;
	function useCachedVersion() {
		self.logger.debug('reading the cached schema file', cachedFileName);
		fs.readFile(cachedFileName, 'UTF-8', function readFile(err, contents) {
			<span class="missing-if-branch" title="if path not taken" >I</span>if (!next) {
<span class="cstat-no" title="statement not covered" >				return;</span>
			}
			<span class="missing-if-branch" title="if path not taken" >I</span>if (err) {
<span class="cstat-no" title="statement not covered" >				next(self.parseError(err));</span>
			}
			else {
				next(null, JSON.parse(contents));
			}
		});
&nbsp;
	}
&nbsp;
	// refresh the schema on a schedule (if schemaRefresh is set)
	<span class="missing-if-branch" title="else path not taken" >E</span>if (self.config.schemaRefresh) {
		setTimeout(<span class="fstat-no" title="function not covered" >function refreshTimer() {</span>
<span class="cstat-no" title="statement not covered" >			var username = self.config.username,</span>
				password = self.config.password + self.config.token;
<span class="cstat-no" title="statement not covered" >			self.baseConnection.login(username, password, <span class="fstat-no" title="function not covered" >function reConnectLoginCallback(err, userInfo) {</span></span>
<span class="cstat-no" title="statement not covered" >				if (err) {</span>
<span class="cstat-no" title="statement not covered" >					self.logger.error('re-login failed');</span>
<span class="cstat-no" title="statement not covered" >					self.logger.error(err);</span>
				}
				else {
<span class="cstat-no" title="statement not covered" >					self.fetchSchema();</span>
				}
			});
		}, typeof(self.config.schemaRefresh) === 'number' ? Math.max(60000, self.config.schemaRefresh) : (<span class="branch-1 cbranch-no" title="branch not covered" >60000 * 30)</span>);
	}
};
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Apr 06 2017 12:19:09 GMT+0300 (EEST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
